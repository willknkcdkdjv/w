<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DOGE</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="app">
    <canvas id="game" width="800" height="500"></canvas>

    <div id="ui">
      <!-- LOGIN -->
      <div id="panel-login" class="panel">
        <div class="title">LOGIN</div>
        <div class="hint">Email + Name (Name is the password)</div>

        <div class="row">
          <label>Email</label>
          <input id="emailInput" type="email" placeholder="you@example.com" />
        </div>

        <div class="row">
          <label>Password</label>
          <input id="passwordInput" type="password" />
        </div>

        <div class="row">
          <label>Name</label>
          <input id="loginNameInput" maxlength="12" placeholder="Player" />
        </div>

        <div class="row buttons">
          <button id="loginBtn">Login</button>
        </div>

        <div id="loginError" class="hint" style="color:#c00; display:none;"></div>
      </div>

      <!-- MENU -->
      <div id="panel-menu" class="panel hidden">
        <div class="title">DOGE</div>
        <div class="hint">Press Enter to Start</div>
        <div class="hint small">Controls: A / D or ← →</div>

        <div class="row buttons">
          <button id="startBtn">Start</button>
        </div>

        <!-- Stats -->
        <div class="stats stats-float">
          <div id="accountName"></div>
          <div id="bestTime"></div>
          <div id="gamesPlayed"></div>
          <div id="avgTime"></div>
        </div>

        <!-- Leaderboard -->
        <div class="lb">
          <div class="lb-title">Leaderboard</div>
          <div class="lb-sub">Top 10 (Longest)</div>
          <ol id="bestList"></ol>
        </div>
      </div>

      <!-- COUNTDOWN -->
      <div id="panel-countdown" class="panel hidden">
        <div id="countText" class="count">2</div>
      </div>

      <!-- PLAYING -->
      <div id="panel-playing" class="panel hidden">
        <div class="hud">
          <div id="timeText">Time: 0.00s</div>
        </div>
      </div>

      <!-- GAMEOVER -->
      <div id="panel-gameover" class="panel hidden">
        <div class="title">GAME OVER</div>

        <div class="bigline">
          <span id="finalTime" class="huge">0.00</span>
          <span class="sec">seconds</span>
        </div>

        <div id="killedBy" class="killed"></div>
        <div id="record" class="record hidden">RECORD BREAKING</div>
        <div class="hint">Press Enter to Restart</div>

        <div class="stats stats-float">
          <div id="accountName"></div>
          <div id="bestTime"></div>
          <div id="gamesPlayed"></div>
          <div id="avgTime"></div>
        </div>

        <div class="lb">
          <div class="lb-title">Leaderboard</div>
          <div class="lb-sub">Top 10 (Longest)</div>
          <ol id="bestList2"></ol>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= Firebase ================= -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, collection, addDoc, query, orderBy, limit, getDocs,
    serverTimestamp, doc, runTransaction, getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import {
    getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
    signInWithEmailAndPassword, updateProfile
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  // ================= Firebase config =================
  const firebaseConfig = {
    apiKey: "AIzaSyCb5w8jk77GnaeC9YnZcI6lfwObEXB9nN8",
    authDomain: "doge-9ba16.firebaseapp.com",
    projectId: "doge-9ba16",
    storageBucket: "doge-9ba16.firebasestorage.app",
    messagingSenderId: "353763869004",
    appId: "1:353763869004:web:3410452212d77e893acfe9"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // ================= Collections =================
  const scoresCol = collection(db, "scores");
  const statsRef = (uid) => doc(db, "userStats", uid);

  // ================= Leaderboard =================
  async function submitScore({ uid, name, time, killedBy }) {
    await addDoc(scoresCol, {
      uid,
      name,
      time,
      killedBy,
      createdAt: serverTimestamp(),
    });
  }

  async function fetchTop(n = 10) {
    const q = query(scoresCol, orderBy("time", "desc"), limit(n));
    const snap = await getDocs(q);
    return snap.docs.map(d => d.data());
  }

  async function fetchBottom(n = 5) {
    const q = query(scoresCol, orderBy("time", "asc"), limit(n));
    const snap = await getDocs(q);
    return snap.docs.map(d => d.data());
  }

  // ================= User stats =================
  async function readMyStats(uid) {
    const snap = await getDoc(statsRef(uid));
    return snap.exists()
      ? snap.data()
      : { gamesPlayed: 0, totalTime: 0, bestTime: 0 };
  }

  async function updateMyStats(uid, timeSec) {
    await runTransaction(db, async (tx) => {
      const ref = statsRef(uid);
      const snap = await tx.get(ref);
      const cur = snap.exists()
        ? snap.data()
        : { gamesPlayed: 0, totalTime: 0, bestTime: 0 };

      tx.set(ref, {
        gamesPlayed: cur.gamesPlayed + 1,
        totalTime: cur.totalTime + timeSec,
        bestTime: Math.max(cur.bestTime, timeSec),
        updatedAt: serverTimestamp(),
      }, { merge: true });
    });
  }

  // ================= Auth =================
  async function loginOrRegister({ email, password, displayName }) {
    try {
      return (await signInWithEmailAndPassword(auth, email, password)).user;
    } catch {
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      if (displayName) await updateProfile(cred.user, { displayName });
      return cred.user;
    }
  }

  // ================= Expose to window =================
  window.fbauth = { auth, onAuthStateChanged, loginOrRegister };
  window.fbscores = {
    submitScore,
    fetchTop,
    fetchBottom,
    readMyStats,
    updateMyStats,
  };

  console.log("Firebase module loaded", window.fbscores);
</script>

  <script src="main.js"></script>
</body>
</html>