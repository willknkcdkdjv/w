<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DOGE</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="app">
    <canvas id="game" width="800" height="500"></canvas>

    <div id="ui">
      <div id="panel-login" class="panel">
        <div class="title">LOGIN</div>
        <div class="hint">Email + Name (Name is the password)</div>

        <div class="row">
          <label>Email</label>
          <input id="emailInput" type="email" placeholder="you@example.com" />
        </div>

        <div class="row">
          <label>Password</label>
          <input id="passwordInput" type="password" placeholder="Your password" />
        </div>

        <div class="row">
          <label>Name</label>
          <input id="loginNameInput" maxlength="12" placeholder="Player" />
        </div>

        <div class="row buttons">
          <button id="loginBtn">Login</button>
        </div>

        <div id="loginError" class="hint" style="color:#c00; display:none;"></div>
      </div>

      <div id="panel-menu" class="panel hidden">
        <div class="title">DOGE</div>
        <div class="hint">Press Enter to Start</div>
        <div class="hint small">Controls: A / D or ← → to dodge</div>

        <div class="row buttons">
          <button id="startBtn">Start</button>
        </div>

        <!-- Stats：左下角 -->
        <div class="stats stats-float">
          <div id="accountName"></div>
          <div id="bestTime"></div>
          <div id="gamesPlayed"></div>
          <div id="avgTime"></div>
        </div>

        <!-- Leaderboard：右上角 -->
        <div class="lb">
          <div class="lb-title">Leaderboard</div>
          <div class="lb-sub">Top 10 (Longest)</div>
          <ol id="bestList"></ol>
        </div>
      </div>

      <div id="panel-countdown" class="panel hidden">
        <div id="countText" class="count">3</div>
      </div>

      <div id="panel-playing" class="panel hidden">
        <div class="hud">
          <div id="timeText">Time: 0.00s</div>
        </div>
      </div>

      <div id="panel-gameover" class="panel hidden">
        <div class="title">GAME OVER</div>

        <div class="bigline">
          <span id="finalTime" class="huge">0.00</span>
          <span class="sec">seconds</span>
        </div>

        <div id="killedBy" class="killed">Kill by ???</div>
        <div id="record" class="record hidden">RECORD BREAKING</div>
        <div class="hint">Press Enter to Restart</div>

        <div class="stats stats-float">
          <div id="accountName2"></div>
          <div id="bestTime2"></div>
          <div id="gamesPlayed2"></div>
          <div id="avgTime2"></div>
        </div>

        <div class="lb">
          <div class="lb-title">Leaderboard</div>
          <div class="lb-sub">Top 10 (Longest)</div>
          <ol id="bestList2"></ol>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= Firebase (一定要先跑) ================= -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, collection, addDoc, query, orderBy, limit, getDocs,
    serverTimestamp, doc, runTransaction, getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import {
    getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
    signInWithEmailAndPassword, updateProfile, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // ⚠️ 換成你 Firebase Console 給你的「真的 config」
    const firebaseConfig = {
    apiKey: "AIzaSyCb5w8jk77GnaeC9YnZcI6lfwObEXB9nN8",
    authDomain: "doge-9ba16.firebaseapp.com",
    projectId: "doge-9ba16",
    storageBucket: "doge-9ba16.firebasestorage.app",
    messagingSenderId: "353763869004",
    appId: "1:353763869004:web:3410452212d77e893acfe9",
    measurementId: "G-CWDG44YNQ9"
     };

    const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // ---------- Public leaderboard ----------
  const scoresCol = collection(db, "scores");

  async function submitScore({ uid, name, time, killedBy }) {
    await addDoc(scoresCol, {
      uid,
      name,
      time,
      killedBy,
      createdAt: serverTimestamp(),
    });
  }

  async function fetchTop(n = 10) {
    const q = query(scoresCol, orderBy("time", "desc"), limit(n));
    const snap = await getDocs(q);
    return snap.docs.map(d => d.data());
  }

  async function fetchBottom(n = 5) {
    const q = query(scoresCol, orderBy("time", "asc"), limit(n));
    const snap = await getDocs(q);
    return snap.docs.map(d => d.data());
  }

  // ---------- Per-user stats (uid) ----------
  function statsRef(uid) {
    return doc(db, "userStats", uid);
  }

  async function readMyStats(uid) {
    const snap = await getDoc(statsRef(uid));
    if (!snap.exists()) return { gamesPlayed: 0, totalTime: 0, bestTime: 0 };
    return snap.data();
  }

  async function updateMyStats(uid, timeSec) {
    const ref = statsRef(uid);
    await runTransaction(db, async (tx) => {
      const snap = await tx.get(ref);
      const cur = snap.exists() ? snap.data() : { gamesPlayed: 0, totalTime: 0, bestTime: 0 };

      const nextGames = (cur.gamesPlayed || 0) + 1;
      const nextTotal = (cur.totalTime || 0) + timeSec;
      const nextBest  = Math.max((cur.bestTime || 0), timeSec);

      tx.set(ref, {
        gamesPlayed: nextGames,
        totalTime: nextTotal,
        bestTime: nextBest,
        updatedAt: serverTimestamp(),
      }, { merge: true });
    });
  }

  // ---------- Auth API ----------
  async function loginOrRegister({ email, password, displayName }) {
    try {
      const cred = await signInWithEmailAndPassword(auth, email, password);
      return cred.user;
    } catch (e) {
      // 沒帳號就註冊（正式產品通常會分開按鈕，這裡走 MVP）
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      if (displayName) await updateProfile(cred.user, { displayName });
      return cred.user;
    }
  }

  async function logout() {
    await signOut(auth);
  }

  window.fbauth = { auth, onAuthStateChanged, loginOrRegister, logout };
  window.fbscores = { submitScore, fetchTop, fetchBottom, readMyStats, updateMyStats };
</script>

<script src="main.js"></script>
</body>
</html>